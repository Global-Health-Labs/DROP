## Background 

The DROP system utilizes an integrated camera in the Hamilton STAR to take LFA images at precise location(s) and time(s). These images are automatically saved by VENUS software into a folder titled "Images" that is generated by VENUS in the location where the worklist is stored on the computer. The images are saved using a consistent naming convention, as described below. This naming convention allows for consistent tracking for the images generated from a given worklist. 

> 'LFA ID #' _ 'Date in YYYYDDMM format' _ 'Time in HHMMSS format'.png  

## Image Analysis Code Overview

:fontawesome-brands-github: - LFA Image Analysis 

The LFA Image Analysis code developed for the DROP system takes either an entire folder of images generated by a given worklist or can batch process multiple folders. Below is a high level description for the process carried out by the LFA Image Analysis code. This is completed for every single image in the folder(s) that is/are being analyzed. 

1.	**Load image:** Loads the image (png) taken by the robot.

![LFA Load Image](./images/LFA%20Load%20Image.png) <br>
<small>Figure 1. LFA image taken by DROP platform. </small>

2.	**Simple crop:** Simple crop as defined by input image processing parameters. The region is roughly identified in yellow in the image below. 

![LFA Simple Crop](./images/LFA%20Simple%20Crop.png) <br>
<small>Figure 2. First crop based on user defined region to reduce file size and simplify identification of lines during second crop. </small>

3.	**Second crop:** Uses line identification to narrow the analysis window to just the read window on the RDT cassette. The area that will be analyzed is in the middle section of the cassette, as highlighted in green below. This avoids any interference due to uneven lighting and shadows that may occur for some RDTs. 

![LFA Second Crop](./images/LFA%20Second%20Crop.png) <br>
<small>Figure 3. Second crop narrows read window based on read window in cassette. </small>

4.	**Quantify:** Determines intensity of signal at the test and control lines by using measuring the mean intensity along each column in the image. Line detrend can be used to flatten the curve and account for uneven lighting. 

![LFA Line Quantify](./images/LFA%20Line%20Quantify.png) <br>
<small>Figure 4. Graph of quantified signal from a two-line LFA. </small>


## Code variations and modifications 

The LFA Image Analysis code was designed to be flexible for various LFA and RDT formats. The parameters that are required are included below. Each of these parameters can be modified based on the requirements for the specific LFA that is being run. 

**Required parameters:**

+	Region to be analyzed (spot or line)
+	Color channel (red, green, blue, or gray)
+	If lines, number of lines to be analyzed
+	Read window size and location 
+	Background color (light or dark)

## Instructions for use

1. **Install Jupyter Notebook** If not already installed 
    + From Terminal: Follow the instructions described here https://www.geeksforgeeks.org/install-jupyter-notebook-in-windows/
    + From Anaconda (recommended)
        + Install Anaconda: Follow the instructions described here https://www.geeksforgeeks.org/how-to-install-anaconda-on-windows/
        + Install Jupyter Notebook in Anaconda: Follow the instructions here https://www.geeksforgeeks.org/install-jupyter-notebook-in-windows/
2. **Copy analysis files to the experiment folder** 
    + Jupyter Notebook: ‘Batch_files_and_run.ipynb’
    + Python file(s): ‘backend.py’, ‘generate_batch_files_and_run.py’, ‘Hamilton_image_analysis.py’
3. **Launch Jupyter Notebook**
    + Option 1: Command prompt 
        + Open your terminal or command prompt.
        + Run the following command to start Jupyter Notebook: jupyter notebook
    + Option 2: Anaconda 
        + Open Anaconda
        + Click on the Jupyter notebook icon
    + Option 3: Programs (works only if Anaconda is installed)
        + Navigate to Jupyter notebook in programs or by typing in the OS search bar
4. **Open the Notebook**
    + A new tab will open in your default web browser showing the Jupyter Notebook interface.
    + Navigate through the file browser to find and click on ‘Batch_files_and_run.ipynb’ file.
5. **Run each Kernel**
    + Run one Kernel at a time by selecting the Kernel and pressing Shift + Enter or by selecting the “Run” button on the toolbar. 
    + When a Kernel is running, a [*] will appear next to “In” on the left-hand side. Once it is complete there will be a number that appears inside the brackets. 
    + *Note: Make sure to run the Kernels in order. The analysis will not complete successfully if they are run out of order.* 
6. **Review Output**
    + In the analysis folder, the following file will be generated
        + all_results.csv
        + A batch file for every folder of images that is analyzed. Naming will be “Folder name”.bat
    + In the image folder, the following files will be generated
        + image.csv
        + image_ROI_line.pdf
7. Save and shut down 
    + Remember to save your work frequently by clicking the save icon or pressing Ctrl + S.
    + When you’re done, you can shut down the notebook by closing the browser tab and stopping the Jupyter server in your terminal by pressing Ctrl + C.

### Project layout after successful analysis

    backend.py                          # Backend code that enables image processing and analysis. 
    generate_batch_files_and_run.ipynb  # Jupyter notebook that generates batch files and runs analysis. 
    Hamilton_image_analysis.py          
    images.bat                          # Batch file  for each folder of images to be analyzed.
    all_results.csv                     # CSV file with the data from all images analyzed.
    images/                             # Folder of images to be analyzed. 
        image.csv                       # CSV file with the data generated from the images in this folder.
        image_ROI_line.pdf              # PDF with images and curves generated from data in this folder. 
        ...                             # Images identified for analysis.

